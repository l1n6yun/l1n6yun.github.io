title: '小程序之封装请求 '
author: l1n6yun
tags: []
categories:
  - 小程序
date: 2020-01-16 00:33:03
---
实现了 promise 的封装，支持GET、POST、PUT 和DELELE这里设计的时候就确定为仅满足单项目通用即可，所以实现的时候融入了部分业务层面的逻辑：

- 接口首次格式化，兼容标准的json和var形式接口（内部有大量var形式的接口）
- 直判断返回值在逻辑上是成功还是失败
- 针对返回未登录的情况，自动跳转登录流程

所以省去了业务调用侧的反复判断处理通用逻辑，使用更简洁。

```js
var host = "http://www.baidu.com";

var showLoading = null;

module.exports = {
  HOST: host,
  API_ROOT: host + '/api/',
  API_VERSION: '1.0.0',
  get(options) {
    options.method = 'GET';
    return this.request(options);
  },
  post(options) {
    options.method = 'POST';
    return this.request(options);
  },
  delete(options) {
    options.method = 'DELETE';
    return this.request(options);
  },
  put(options) {
    options.method = 'PUT';
    return this.request(options);
  },
  request(options) {
    var that = this
    var apiRoot = this.API_ROOT;

    var token = '';
    try {
      token = wx.getStorageSync('token')
    } catch (e) {}

    var requireLogin = true;
    if (typeof options.login == 'undefined' || options.login == true) {
      requireLogin = true;
    } else {
      requireLogin = false;
    }

    if (typeof options.loading != 'undefined' && options.loading == true) {
      clearTimeout(showLoading)
      showLoading = setTimeout(function() {
        wx.showToast({
          title: "加载中",
          icon: "loading",
          duration: 1e4
        });
      }, 500)
    }

    return new Promise((resolve, reject) => {
      wx.request({
        url: apiRoot + options.url,
        data: options.data,
        method: options.method ? options.method : 'POST',
        header: {
          'Cache-Control': 'no-cache',
          'Content-Type': 'application/x-www-form-urlencoded',
          'XX-Token': token,
          'XX-Device-Type': 'wxapp',
          'XX-Api-Version': that.API_VERSION
        },
        success: (res) => {
          clearTimeout(showLoading)
          wx.hideToast()
          if (res.data.code == 10001 && requireLogin) {
            // 执行登陆
            let currentPages = getCurrentPages();
            let currentRoute = currentPages.pop()['__route__'];
            if (currentRoute != 'pages/login/login') {
              wx.navigateTo({
                url: '/pages/login/login'
              });
            }
          } else {
            resolve(res)
          }
        },
        fail: (error) => {
          clearTimeout(showLoading)
          wx.hideToast()
          reject(error)
        }
      })
    })
  }
}
```

```js
import ajax from '../utils/ajax.js'

ajax.get({
  url: url,
  login: false,
  loading: true,
}).then((res) => {
  console.log(res)
}).catch((error) => {
  console.log(error)
})
```